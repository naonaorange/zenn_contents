---
title: "STM32ã®PWMã®ä½¿ã„æ–¹ã¾ã¨ã‚"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["stm32"]
published: true
---

# åŸºæœ¬çš„ãª PWM å‡ºåŠ›

ã¾ãšã¯ CubeMX ã®è¨­å®šå¤‰æ›´ã‚„ã‚³ãƒ¼ãƒ‰ã‚’æœ€å°é™ã«ã—ãŸåŸºæœ¬çš„ãª PWM å‡ºåŠ›ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚
CubeMX ã§æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€CubeMx GUI ã§ä¸‹è¨˜ã®è¨­å®šã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```
- Pinout and Configuration
    - Timers
        - TIM1
            - Mode
                - Clock Source : Internal Clock
                - Channed1 : PWM Generation CH1
            - Configuration
                - Parameter Settings
                    - Counter Settings
                        - Prescaler : 15
                        - Counter Period(Auto Reload Register) : 999
```

ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’ã—ãŸå¾Œã€Cube IDE ã§ main.c ã«ä¸‹è¨˜ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```c
/* USER CODE BEGIN 2 */
HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_1);
__HAL_TIM_SET_COMPARE(&htim1, TIM_CHANNEL_1, 699);
/* USER CODE END 2 */
```

PWM ã®å‘¨æœŸã¯ä¸‹è¨˜è¨ˆç®—ã§å°ã‘ã¾ã™ã€‚HCLK ã¯ CubeMX ã® GUI ä¸Šã§ç¢ºèªã§ãã¾ã™ãŒã€Nucleo STM32F4 è©•ä¾¡ãƒœãƒ¼ãƒ‰ã§ã¯ 16[MHz]ã§ã—ãŸã€‚

$$
PWMFreq = \frac{HCLK}{Prescaler} = \frac{16[MHz]}{16} = 1[MHz]
$$

åˆæœŸçŠ¶æ…‹ã§ã¯æ³¢å½¢ã¯ã®ã“ãã‚Šæ³¢ã¨ãªã‚Šã€Counter Period(Auto Reload Register)ã« 999 ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ã€999 ã®æ¬¡ã¯ 0 ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹æ³¢å½¢ã«ãªã‚Šã¾ã™ã€‚
ã¤ã¾ã‚Šã€å‘¨æœŸãŒ 1msã€High æ™‚é–“ãŒ 0.7ms ã® PWM å‡ºåŠ›ãŒè¡Œã‚ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

![](/images/20231220_stm32f4_tim_pwm/basic_pwm.png)

# PWM å‡ºåŠ›ã®è«–ç†ã‚’åè»¢ã•ã›ã‚‹

PWM ãƒ¢ãƒ¼ãƒ‰ã¨ã„ã†è¨­å®šãŒã‚ã‚Šã€ã“ã‚Œã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ PWM ã®åˆæœŸå‡ºåŠ›ã‚’ High ã«ã™ã‚‹ã‹ Low ã«ã™ã‚‹ã‹è¨­å®šã§ãã¾ã™ã€‚
CubeMX ã§å¤‰æ›´å¯èƒ½ã§ã™ã€‚

```
- Pinout and Configuration
    - Timers
        - TIM1
            - Configuration
                - Parameter Settings
                    - PWM Generation Channel 1
                        - Mode : PWM mode 1 OR PWM mode 2
```

- PWM mode 1
  - CCR ä»¥ä¸‹ã®æ™‚ã¯ High, CCR ã‚’è¶…ãˆã‚‹ã¨ Low
- PWM mode 2
  - CCR ä»¥ä¸‹ã®æ™‚ã¯ Low, CCR ã‚’è¶…ãˆã‚‹ã¨ High

![](/images/20231220_stm32f4_tim_pwm/pwm_mode.png)

# æ³¢å½¢ã®ç¨®é¡(ã®ã“ãã‚Šæ³¢ã‚„ä¸‰è§’æ³¢)ã‚’è¨­å®šã™ã‚‹

Counter ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šã§æ³¢å½¢ã®ç¨®é¡ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚
Center Aligned Mode ã«ã¯ 1-3 ã¨ç¨®é¡ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯ãƒ¬ã‚¸ã‚¹ã‚¿ã®æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒç•°ãªã‚‹ã®ã¿ã§ã™ã®ã§ã€æ³¢å½¢ã®ç¨®é¡ã¯åŒã˜ã§ã™ã€‚

```
- Pinout and Configuration
    - Timers
        - TIM1
            - Configuration
                - Parameter Settings
                    - Counter Settings
                        - Counter Mode : Up OR Down OR Cennter Aligned Mode 1-3
```

![](/images/20231220_stm32f4_tim_pwm/pwm_counter_mode.png)

# ãƒ¬ã‚¸ã‚¹ã‚¿ã®æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨­å®šã™ã‚‹

PWM ã® Duty ã‚„å‘¨æœŸã‚’æ›´æ–°ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°(UEV: Update EVent)ã¯æ³¢å½¢ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚ã¾ãŸã€ä¸‰è§’æ³¢ã®å ´åˆã¯æ›´æ–°ã—ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```
- Pinout and Configuration
    - Timers
        - TIM1
            - Configuration
                - Counter Settings
                    - auto reload preload : Enable
                - Parameter Settings
                    - Counter Settings
                        - Counter Mode : Up OR Down OR Cennter Aligned Mode 1-3
```

![](/images/20231220_stm32f4_tim_pwm/pwm_update_timing.png)

åŠ ãˆã¦ã€auto reload preload æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«å¤‰æ›´ã—ã¾ã™ã€‚
auto reload preload ã¯ ARR(Auto Reload Resister)ã®å€¤ã‚’å¤‰æ›´ã™ã‚‹éš›ã®ãƒãƒƒãƒ•ã‚¡ãƒ¼ã®ã‚ˆã†ãªã‚‚ã®ã§ã€ãƒãƒƒãƒ•ã‚¡ãƒ¼ã®å€¤ã‚’å¤‰æ›´ã—ã¦ãŠã‘ã° Update Event ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è‡ªå‹•çš„ã« ARR ã®å€¤ãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚
STMicro å…¬å¼ã®ãƒ¬ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®å›³ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã®ã§ã“ã‚Œã§è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚

- ARPE(Auto Reload Preload)ãŒç„¡åŠ¹ã®å ´åˆ

ARR(è‡ªå‹•å†ãƒ­ãƒ¼ãƒ‰ãƒ¬ã‚¸ã‚¹ã‚¿)ã®å€¤ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å¤‰æ›´ã™ã‚‹ã¨ã€å½“ãŸã‚Šå‰ã§ã™ãŒãã®å¤‰æ›´ãŒå³æ™‚åæ˜ ã•ã‚Œã¾ã™ã€‚

![](/images/20231220_stm32f4_tim_pwm/pwm_update_timing_auto_reload_preload_disable.png)

- ARPE(Auto Reload Preload)ãŒç„¡åŠ¹ã®å ´åˆ

ARR å€¤ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å¤‰æ›´ã™ã‚‹ã¨ã€ã¾ãšã¯ ARPE ãƒ¬ã‚¸ã‚¹ã‚¿ã®å€¤ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚
ãã—ã¦ã€UEV ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è‡ªå‹•çš„ã« ARR ã®å€¤ãŒ ARPE ãƒ¬ã‚¸ã‚¹ã‚¿ã®å€¤ã§æ›´æ–°ã•ã‚Œã‚‹ã¨ã„ã†å‡¦ç†ã«ãªã‚Šã¾ã™ã€‚
ã“ã®å ´åˆã€ARR å€¤å¤‰æ›´ãŒå®Ÿéš›ã«å¤‰æ›´ã•ã‚Œã‚‹ã®ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã‚ˆã‚‹å€¤ã®å¤‰æ›´æ™‚ã§ã¯ãªãã€UEV ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ãªã‚‹ã“ã¨ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

![](/images/20231220_stm32f4_tim_pwm/pwm_update_timing_auto_reload_preload_enable.png)

# çµ„ã¿åˆã‚ã› PWM

çµ„ã¿åˆã‚ã› PWM ã¯ 2CH ã®æ³¢å½¢ã®çµ„ã¿åˆã‚ã›(AND OR)ã¦ã‚ˆã‚Šè¤‡é›‘ãª PWM æ³¢å½¢ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- AND ã®å ´åˆ

ä¾‹ã¨ã—ã¦ TIM1 ã® CH1 ã¨ CH2 ã‚’çµ„ã¿åˆã‚ã›ã¦ã€ä¸‰è§’æ³¢ã®é€”ä¸­ã§ç«‹ã¡ä¸‹ãŒã‚‹ Duty50%ã® PWM å‡ºåŠ›ã•ã›ã¾ã™ã€‚
çµ„ã¿åˆã‚ã›ãŸ PWM æ³¢å½¢ã¯ CH1 ã®å‡ºåŠ›ãƒãƒ¼ãƒˆã‹ã‚‰å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

CubeIDE GUI ã«ã‚ˆã‚‹è¨­å®šã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã—ã¦ä¸‹ã•ã„ã€‚

```
- Pinout and Configuration
    - Timers
        - TIM1
            - Mode
                - Clock Source : Internal Clock
                - Channed1 : PWM Generation CH1
                - Channed2 : PWM Generation CH2
            - Configuration
                - Parameter Settings
                    - Counter Settings
                        - Prescaler : 15
                        - Counter Period(Auto Reload Register) : 999
                    - PWM Generation Channel1
                        - Mode : Combined PWM2
                    - PWM Generation Channel2
                        - Mode : PWM mode 1
```

ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå¾Œã€main.c ã«ä¸‹è¨˜ã‚’è¿½è¨˜ã—ã¦ä¸‹ã•ã„ã€‚

```
  /* USER CODE BEGIN 2 */
  HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_1);
  HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_2);
  __HAL_TIM_SET_COMPARE(&htim1, TIM_CHANNEL_1, 299);
  __HAL_TIM_SET_COMPARE(&htim1, TIM_CHANNEL_2, 799);
  /* USER CODE END 2 */
```

![](/images/20231220_stm32f4_tim_pwm/pwm_combine.png)

- OR ã®å ´åˆ

ä¾‹ã¨ã—ã¦ TIM1 ã® CH1 ã¨ CH2 ã‚’çµ„ã¿åˆã‚ã›ã¦ã€ä¸‰è§’æ³¢ã®é€”ä¸­ã§ç«‹ã¡ä¸‹ãŒã‚‹ Duty50%ã® PWM å‡ºåŠ›ã•ã›ã¾ã™ã€‚
çµ„ã¿åˆã‚ã›ãŸ PWM æ³¢å½¢ã¯ CH1 ã®å‡ºåŠ›ãƒãƒ¼ãƒˆã‹ã‚‰å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

CubeIDE GUI ã«ã‚ˆã‚‹è¨­å®šã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã—ã¦ä¸‹ã•ã„ã€‚

```
- Pinout and Configuration
    - Timers
        - TIM1
            - Mode
                - Clock Source : Internal Clock
                - Channed1 : PWM Generation CH1
                - Channed2 : PWM Generation CH2
            - Configuration
                - Parameter Settings
                    - Counter Settings
                        - Prescaler : 15
                        - Counter Period(Auto Reload Register) : 999
                    - PWM Generation Channel1
                        - Mode : Combined PWM1
                    - PWM Generation Channel2
                        - Mode : PWM mode 2
```

ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå¾Œã€main.c ã«ä¸‹è¨˜ã‚’è¿½è¨˜ã—ã¦ä¸‹ã•ã„ã€‚

```
  /* USER CODE BEGIN 2 */
  HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_1);
  HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_2);
  __HAL_TIM_SET_COMPARE(&htim1, TIM_CHANNEL_1, 299);
  __HAL_TIM_SET_COMPARE(&htim1, TIM_CHANNEL_2, 799);
  /* USER CODE END 2 */
```

![](/images/20231220_stm32f4_tim_pwm/pwm_combine2.png)
